<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=480; user-scalable=no" />
		<meta http-equiv="Content-type" content="text/html; charset=utf-8">
		<title>The Placemarker App</title>
		<link rel="stylesheet" href="master.css" type="text/css" media="screen" title="no title" charset="utf-8">
		<script type="text/javascript" charset="utf-8" src="jquery.js"></script>
		<script type="text/javascript" charset="utf-8" src="jquery.json.js"></script>
		
		<script type="text/javascript" charset="utf-8" src="phonegap.js"></script>
	
		<script type="text/javascript" charset="utf-8">
			var watchID = null;
			  
		    var getLocation = function(mode) {
		    	//var loc_des = prompt("Location description", "");
		    	//showMap($('#theMapView'),'mode=save&loc_des='+ loc_des +'&mobileApp=true&ll=10.7702,106.708338');
		      var suc = function(p){
				    //alert(p.coords.latitude + " " + p.coords.longitude);
				    var ll = p.coords.latitude + "," + p.coords.longitude;
				    if(mode == "save") {
				    	var loc_des = prompt("Location description", "");
				    	showMap($('#theMapView'),'mode=save&loc_des='+ loc_des +'&mobileApp=true&ll=' + ll);
				    } else {			    	
				    	if($(node).attr('src').length > 0){
				    		$('#theMapView')[0].contentWindow.updateRootMarker(p.coords.latitude, p.coords.longitude);
				    	} else {
				    		showMap($('#theMapView'),'mobileApp=true&ll=' + ll);
				    	}
				    }
		      };
		      var fail = function(){ alert('getCurrentPosition failed!');};
		      navigator.geolocation.getCurrentPosition(suc,fail,{enableHighAccuracy:true});
		    }
	
		    function test1(){
		    	$('#theMapView')[0].contentWindow.updateRootMarker(10.7902,106.18338);		    
			}
	
		    function mapLoaded(node) {
			    try {
				    $(node).show();
			    } catch(e) {alert(e.message);}
		    }
		
			function showMap(node,params){
				var map_url = "http://drd-vn-database.com/mobile/v_map_mobile.html?" + params;
				$(node).attr('src',map_url).show();
			}
	
		    // PhoneGap is ready
		    //
		    function onDeviceReady() {
		        var options = { frequency: 8000 , enableHighAccuracy:true};  // Update every 8 seconds
		        watchID = navigator.geolocation.watchPosition(onWatchPositionSuccess, onWatchPositionError, options);
		    }
	
		    function onLocationChanged(latitude, longitude ) {
		        var element = document.getElementById('geolocation');
		        element.innerHTML = 'LocationChanged, Latitude: '  + latitude + ', ' + 'Longitude: ' + longitude + '<hr />';
		    }
	
		    function onWatchPositionSuccess(position) {
			    try {
			        var element = document.getElementById('geolocation');
			        element.innerHTML = 'Latitude: '  + position.coords.latitude + ', Longitude: ' + position.coords.longitude + '<hr />';
			        $('#theMapView')[0].contentWindow.updateRootMarker(position.coords.latitude, position.coords.longitude);
			    } catch(e) {alert(e.message);}
		    }
	
		    function onWatchPositionError(error) {
		    	// onError Callback receives a PositionError object
		        alert('code: '    + error.code    + '\n' +
		              'message: ' + error.message + '\n');
		    }
					
			function onLoad(){	
			//	showMap($('#theMapView'),'mobileApp=true');		
				document.addEventListener("deviceready", onDeviceReady, false);
			}
	
			$(document).ready(function(){
							
			});
		  </script>
		  <style type="text/css">
		  	#theMapView {
		  		display: none; margin-top: 20px; width:97%; height: 504px;
		  	}
		  </style>
	</head>
	<body onload="onLoad();" id="stage" class="theme">
		<h4>The Placemarker</h4>
		<p id="geolocation">Watching geolocation...</p>
		<a href="#" class="btn " onclick="getLocation('read');">Get My Location</a>
		<a href="#" class="btn " onclick="getLocation('save');">Save My Location</a>
		<iframe onload="mapLoaded(this)" id="theMapView" src="http://drd-vn-database.com/mobile/v_map_mobile.html?mobileApp=true" ></iframe>
	</body>
</html>
